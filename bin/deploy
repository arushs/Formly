#!/bin/bash

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT_DIR"

echo -e "${BLUE}Deploying to production...${NC}\n"

# Ensure we're on master
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "master" ]; then
    echo -e "${RED}Error: Must be on master branch to deploy${NC}"
    echo -e "Current branch: ${YELLOW}$CURRENT_BRANCH${NC}"
    exit 1
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo -e "${RED}Error: Uncommitted changes detected${NC}"
    echo -e "Please commit or stash your changes before deploying."
    exit 1
fi

# Push master to origin
echo -e "${YELLOW}Pushing master to origin...${NC}"
git push origin master

# Create PR from master to production
echo -e "\n${YELLOW}Creating PR from master to production...${NC}"
PR_URL=$(gh pr create \
    --base production \
    --head master \
    --title "Deploy to production" \
    --body "$(cat <<'EOF'
## Deploy

Merge master into production to trigger deployment.

---
ðŸ¤– Generated with `bin/deploy`
EOF
)" 2>&1) || {
    # Check if PR already exists
    if echo "$PR_URL" | grep -q "already exists"; then
        echo -e "${YELLOW}PR already exists. Opening...${NC}"
        gh pr view master --web
        exit 0
    fi
    echo -e "${RED}Failed to create PR${NC}"
    echo "$PR_URL"
    exit 1
}

echo -e "\n${GREEN}PR created successfully!${NC}"
echo -e "${BLUE}$PR_URL${NC}"

# Open PR in browser
gh pr view master --web
