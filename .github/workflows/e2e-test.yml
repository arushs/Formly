name: E2E Tests

on:
  push:
    branches: [production]
  pull_request:
    branches: [production]
  workflow_dispatch:  # Manual trigger

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
        working-directory: apps/api
      
      - name: Run API health check
        run: |
          # Wait for deployment to be ready (if triggered by deploy)
          sleep 30
          
          # Health check
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://tax-agent-api-1glq.onrender.com/health)
          if [ "$STATUS" != "200" ]; then
            echo "API health check failed: $STATUS"
            exit 1
          fi
          echo "API is healthy"
      
      - name: Run E2E smoke test
        env:
          API_URL: https://tax-agent-api-1glq.onrender.com
        run: |
          # Basic API tests
          echo "Testing engagements endpoint..."
          curl -sf "$API_URL/api/engagements" > /dev/null || exit 1
          
          echo "Testing health endpoint..."
          curl -sf "$API_URL/health" | jq -e '.status == "ok"' || exit 1
          
          echo "âœ… Smoke tests passed"
      
      # Full E2E with Shuri (optional - needs OpenClaw connection)
      # - name: Trigger Shuri E2E Test
      #   if: github.event_name == 'push' && github.ref == 'refs/heads/production'
      #   env:
      #     OPENCLAW_URL: ${{ secrets.OPENCLAW_URL }}
      #     OPENCLAW_TOKEN: ${{ secrets.OPENCLAW_TOKEN }}
      #   run: |
      #     curl -X POST "$OPENCLAW_URL/api/sessions/spawn" \
      #       -H "Authorization: Bearer $OPENCLAW_TOKEN" \
      #       -H "Content-Type: application/json" \
      #       -d '{
      #         "label": "shuri",
      #         "task": "Run QA test: formly-full-flow. Report results."
      #       }'

  notify:
    needs: e2e-test
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify on failure
        run: |
          echo "E2E tests failed! Check the logs."
          # Add Slack/Discord notification here if needed
